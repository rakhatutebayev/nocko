# Защита от спама в контактной форме

## Реализованные меры защиты

### 1. ✅ Honeypot поле
- Скрытое поле `website`, которое боты обычно заполняют
- Если поле заполнено, запрос отклоняется как спам
- Невидимо для пользователей

### 2. ✅ Rate Limiting
- Ограничение: **5 запросов в час** с одного IP-адреса
- Автоматическая очистка старых записей каждые 5 минут
- При превышении лимита возвращается ошибка 429 (Too Many Requests)

### 3. ✅ Проверка содержимого на спам
- Фильтрация по ключевым словам спама
- Проверка на множественные ссылки (более 2)
- Проверка на повторяющиеся символы
- Список ключевых слов можно расширить в `apps/cms/src/api/contact/controllers/contact.js`

### 4. ✅ Google reCAPTCHA v3
- Невидимая для пользователей защита
- Оценка поведения пользователя (score от 0.0 до 1.0)
- Запросы с score < 0.5 отклоняются

## Настройка reCAPTCHA v3

### Шаг 1: Получение ключей

1. Перейдите на https://www.google.com/recaptcha/admin/create
2. Заполните форму:
   - **Label**: NOCKO Contact Form
   - **reCAPTCHA type**: reCAPTCHA v3
   - **Domains**: 
     - `localhost` (для разработки)
     - `nocko.com` (для продакшена)
     - `www.nocko.com` (если используется)
3. Примите условия использования
4. Нажмите "Submit"

### Шаг 2: Получение ключей

После регистрации вы получите:
- **Site Key** (публичный ключ) - для фронтенда
- **Secret Key** (секретный ключ) - для бэкенда

### Шаг 3: Настройка переменных окружения

Добавьте в файл `.env` в корне проекта:

```env
# reCAPTCHA Configuration
NEXT_PUBLIC_RECAPTCHA_SITE_KEY=ваш_site_key_здесь
RECAPTCHA_SECRET_KEY=ваш_secret_key_здесь
```

### Шаг 4: Перезапуск сервисов

```bash
docker-compose restart cms website
```

## Как это работает

### Процесс отправки формы:

1. **Клиентская валидация**:
   - Проверка обязательных полей
   - Проверка формата email
   - Проверка honeypot поля

2. **Получение reCAPTCHA токена** (если настроен):
   - Выполняется действие `contact_form_submit`
   - Получается токен от Google

3. **Отправка на сервер**:
   - Все данные + reCAPTCHA токен отправляются на Strapi API

4. **Серверная проверка**:
   - Проверка rate limiting
   - Проверка honeypot поля
   - Проверка reCAPTCHA токена (если предоставлен)
   - Проверка содержимого на спам
   - Валидация данных

5. **Сохранение и отправка email**:
   - Сохранение в базу данных
   - Отправка email получателям

## Настройка параметров

### Rate Limiting

Измените в `apps/cms/src/api/contact/controllers/contact.js`:

```javascript
const maxRequests = 5; // Максимум запросов в час
const oneHour = 60 * 60 * 1000; // Время окна
```

### Список спам-ключевых слов

Расширьте массив `spamKeywords` в функции `checkSpamContent()`:

```javascript
const spamKeywords = [
  'viagra', 'cialis', 'casino', // ... добавьте свои
];
```

### reCAPTCHA Score Threshold

Измените минимальный score в проверке reCAPTCHA:

```javascript
if (recaptchaData.score !== undefined && recaptchaData.score < 0.5) {
  // Измените 0.5 на нужное значение (0.0 - 1.0)
}
```

## Мониторинг

Все подозрительные запросы логируются в консоль Strapi:

- `Spam detected (honeypot)` - заполнено honeypot поле
- `Rate limit exceeded` - превышен лимит запросов
- `reCAPTCHA verification failed` - не пройдена проверка reCAPTCHA
- `Spam content detected` - обнаружен спам в содержимом

## Рекомендации для продакшена

1. **Используйте Redis для rate limiting** вместо Map (текущая реализация)
2. **Настройте мониторинг** подозрительных запросов
3. **Регулярно обновляйте** список спам-ключевых слов
4. **Настройте алерты** при большом количестве заблокированных запросов
5. **Рассмотрите использование** более продвинутых решений (Cloudflare, Akismet)

## Отключение reCAPTCHA

Если reCAPTCHA не настроена (ключи не указаны), форма будет работать без неё, используя только другие меры защиты (honeypot, rate limiting, проверка содержимого).


